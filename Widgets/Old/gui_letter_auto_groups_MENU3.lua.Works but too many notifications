function widget:GetInfo()
    return {
        name      = "Letter UnitType Multi Auto Groups",
        desc      = "Assign multiple unit types to letter groups... + letter = filter from current selection instead of globally.",
        author    = "FrequentPilgrim",
        date      = "2025-06-01",
        license   = "GNU GPL v2",
        layer     = 0,
        enabled   = true
    }
end

-- Forward declarations for menu button callbacks (so Epic Menu buttons can call them)
local AssignLetterGroup
local ClearLetterGroup

-- âœ… Epic Menu option (kept exactly as you had it)
options = {
    {
        key    = 'enableAutoGroups',
        name   = 'Enable Letter UnitType Auto Groups',
        desc   = 'Toggle letter-based auto group assignment and selection.',
        type   = 'bool',
        value  = true,
        scope  = 'widget',
    },
}

-- â–¼â–¼â–¼ Quick Assign & Clear buttons for Aâ€“Z (unchanged behavior, just calls below) â–¼â–¼â–¼
do
    local function _append(item) options[#options+1] = item end

    -- Section label for Assign
    _append({ key = "lbl_assign_letters", type = "text", name = "Quick Assign (Selected â†’ Letter)", value = "" })

    for byte = string.byte("A"), string.byte("Z") do
        local letter = string.char(byte)
        _append({
            key      = "assign_" .. letter,
            name     = "Assign â†’ " .. letter,
            desc     = "Assign CURRENT selectionâ€™s unit types to group " .. letter,
            type     = "button",
            noHotkey = true,
            scope    = "widget",
            OnChange = function() AssignLetterGroup(letter) end,
        })
    end

    -- Section label for Clear
    _append({ key = "lbl_clear_letters", type = "text", name = "Quick Clear (Erase Letter Group)", value = "" })

    for byte = string.byte("A"), string.byte("Z") do
        local letter = string.char(byte)
        _append({
            key      = "clear_" .. letter,
            name     = "Clear " .. letter,
            desc     = "Remove ALL unit types from group " .. letter,
            type     = "button",
            noHotkey = true,
            scope    = "widget",
            OnChange = function() ClearLetterGroup(letter) end,
        })
    end
end
-- â–²â–²â–² End added menu buttons â–²â–²â–²

local assignedGroups = {} -- letter -> set of unitDefNames { [unitDefName] = true, ... }
local keycodeToLetter = {}
local backspaceKey = Spring.GetKeyCode("backspace")
local backspaceDown = false

-- Fill keycodeToLetter for letters A-Z
for i = 65, 90 do
    local ch = string.char(i)
    keycodeToLetter[Spring.GetKeyCode(ch:lower())] = ch
end

-- ðŸ”” Player-visible system-style message (chat/console), unchanged call sites
local function ShowMessage(msg)
    Spring.Echo('game_message: ' .. msg)
end

-- Define after forward-decl so Epic Menu closures see the locals
AssignLetterGroup = function(letter)
    local selUnits = Spring.GetSelectedUnits()
    if #selUnits == 0 then
        ShowMessage("No units selected to assign group " .. letter)
        return
    end

    assignedGroups[letter] = assignedGroups[letter] or {}
    local addedCount = 0
    for _, unitID in ipairs(selUnits) do
        local udid = Spring.GetUnitDefID(unitID)
        if udid then
            local defName = UnitDefs[udid].name
            if defName and not assignedGroups[letter][defName] then
                assignedGroups[letter][defName] = true
                addedCount = addedCount + 1
            end
        end
    end

    if addedCount > 0 then
        ShowMessage("Added " .. addedCount .. " unit types to group " .. letter)
    else
        ShowMessage("No new unit types added to group " .. letter)
    end
end

ClearLetterGroup = function(letter)
    if assignedGroups[letter] then
        assignedGroups[letter] = nil
        ShowMessage("Cleared group " .. letter)
    else
        ShowMessage("Group " .. letter .. " is not assigned")
    end
end

local function GetUnitsInGroup(letter)
    local defNameSet = assignedGroups[letter]
    if not defNameSet then return {} end

    local myTeam = Spring.GetMyTeamID()
    local units = Spring.GetTeamUnits(myTeam)
    local toSelect = {}
    for _, unitID in ipairs(units) do
        local udid = Spring.GetUnitDefID(unitID)
        if udid then
            local defName = UnitDefs[udid].name
            if defNameSet[defName] then
                table.insert(toSelect, unitID)
            end
        end
    end
    return toSelect
end

local function SelectLetterGroup(letter)
    local toSelect = GetUnitsInGroup(letter)
    if #toSelect == 0 then
        ShowMessage("No alive units of group " .. letter)
        return
    end
    Spring.SelectUnitArray(toSelect, false)
    ShowMessage("Selected " .. #toSelect .. " units from group " .. letter)
end

local function AddToSelection(letter)
    local toSelect = GetUnitsInGroup(letter)
    if #toSelect == 0 then
        ShowMessage("No units to add from group " .. letter)
        return
    end
    Spring.SelectUnitArray(toSelect, true)
    ShowMessage("Added " .. #toSelect .. " units from group " .. letter)
end

local function FilterSelection(letter)
    local current = Spring.GetSelectedUnits()
    if #current == 0 then return end

    local defNameSet = assignedGroups[letter]
    if not defNameSet then
        ShowMessage("Group " .. letter .. " not assigned")
        return
    end

    local filtered = {}
    for _, unitID in ipairs(current) do
        local udid = Spring.GetUnitDefID(unitID)
        if udid then
            local defName = UnitDefs[udid].name
            if defNameSet[defName] then
                table.insert(filtered, unitID)
            end
        end
    end

    Spring.SelectUnitArray(filtered, false)
    ShowMessage("Filtered selection to " .. #filtered .. " units in group " .. letter)
end

function widget:KeyPress(key, mods, isRepeat)
    if not options[1].value then return false end  -- âœ… Epic Menu gating (functionality only)

    if key == backspaceKey then
        backspaceDown = true
        return false
    end

    local letter = keycodeToLetter[key]
    if not letter or not mods.meta then return false end

    if backspaceDown then
        ClearLetterGroup(letter)
        return true
    elseif mods.alt then
        AssignLetterGroup(letter)
        return true
    elseif mods.shift then
        AddToSelection(letter)
        return true
    elseif mods.ctrl then
        FilterSelection(letter)
        return true
    else
        SelectLetterGroup(letter)
        return true
    end
end

function widget:KeyRelease(key)
    if key == backspaceKey then
        backspaceDown = false
    end
end

function widget:GetConfigData()
    local saved = { enableAutoGroups = options[1].value }
    for letter, defSet in pairs(assignedGroups) do
        saved[letter] = {}
        for defName in pairs(defSet) do
            table.insert(saved[letter], defName)
        end
    end
    return saved
end

function widget:SetConfigData(data)
    if type(data) == "table" then
        options[1].value = data.enableAutoGroups or true
        assignedGroups = {}
        for letter, defList in pairs(data) do
            if type(defList) == "table" then
                assignedGroups[letter] = {}
                for _, defName in ipairs(defList) do
                    assignedGroups[letter][defName] = true
                end
            end
        end
        WG.LetterUnitTypeMultiAutoGroups = assignedGroups
        Spring.Echo("[LetterUnitTypeGroups] Loaded saved groups") -- left untouched
    end
end
