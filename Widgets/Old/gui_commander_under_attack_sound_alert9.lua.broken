function widget:GetInfo()
  return {
    name      = "Commander Damage Alert",
    desc      = "Plays a sound when your commander takes damage",
    author    = "ChatGPT + User",
    date      = "2025-06-09",
    license   = "MIT",
    layer     = 0,
    enabled   = true,
  }
end

local GetMyTeamID         = Spring.GetMyTeamID
local GetUnitTeam         = Spring.GetUnitTeam
local GetUnitDefID        = Spring.GetUnitDefID
local GetUnitRulesParam   = Spring.GetUnitRulesParam
local PlaySoundFile       = Spring.PlaySoundFile
local Echo                = Spring.Echo

local UnitDefs            = UnitDefs
local lastCommanderAlertTime = 0
local COOLDOWN = 15  -- seconds
local SOUND_FILE = "sounds/commanderistakingfire.ogg"

-- Robust commander detection
local function IsCommander(unitID, unitDefID)
  local unitDef = UnitDefs[unitDefID]
  if not unitDef then return false end

  local name = unitDef.name or "unknown"
  local isCmd = GetUnitRulesParam(unitID, "iscommander")
  local commtype = GetUnitRulesParam(unitID, "commtype")
  local level = GetUnitRulesParam(unitID, "level")

  if isCmd == 1 then
    Echo("[Commander Alert] Detected via 'iscommander' param:", unitID, "("..name..")")
    return true
  end

  if commtype or (level and level > 0) then
    Echo("[Commander Alert] Detected via 'commtype' or 'level' param:", unitID, "("..name..")")
    return true
  end

  local commanderPrefixes = {
    "dynrecon", "dynstrike", "dynassault", "dynsupport", "dynknight",
    "dyntrainer", "zk_commander", "zk_custom", "zk_chassis", "comm"
  }
  for _, prefix in ipairs(commanderPrefixes) do
    if name:sub(1, #prefix) == prefix then
      Echo("[Commander Alert] Detected by name prefix match:", unitID, "("..name..")")
      return true
    end
  end

  if name:find("_base") then
    Echo("[Commander Alert] Detected by '_base' fallback check:", unitID, "("..name..")")
    return true
  end

  Echo("[Commander Alert] Unit", unitID, "("..name..") is not a commander. Ignoring.")
  return false
end

function widget:UnitDamaged(unitID, unitDefID, unitTeam, damage, paralyzer, weaponID, attackerID, attackerDefID, attackerTeam)
  local myTeamID = GetMyTeamID()
  if unitTeam ~= myTeamID then return end

  if not IsCommander(unitID, unitDefID) then return end

  local timeNow = Spring.GetGameSeconds()
  if timeNow - lastCommanderAlertTime < COOLDOWN then
    Echo("[Commander Alert] Commander hit, but cooldown active.")
    return
  end

  Echo("[Commander Alert] Your commander took damage! Playing sound.")
  PlaySoundFile(SOUND_FILE, 1.0)
  lastCommanderAlertTime = timeNow
end
