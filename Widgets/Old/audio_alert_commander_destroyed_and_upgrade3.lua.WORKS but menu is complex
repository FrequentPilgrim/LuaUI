function widget:GetInfo()
	return {
		name      = "Commander Alerts (Upgrade vs Death)",
		desc      = "Client-side pairing of commander destroy/create to play distinct audio + optional system text.",
		author    = "JHB + GPT",
		date      = "2025-08-16",
		license   = "GPLv2+",
		layer     = 0,
		enabled   = true,
	}
end

--------------------------------------------------------------------------------
-- Epic Menu (Settings/Audio/Audio Alerts)
--------------------------------------------------------------------------------
options_path  = 'Settings/Audio/Audio Alerts'
options_order = {
  "enable", "allyOnly", "showText", "volume",
  "soundDeath", "soundUpgrade",
  "detectWindow", "detectRadius",
}

options = {
  enable = {
    name="Commander Alerts",
    desc="Enable distinct audio + (optional) text for commander death vs upgrade.",
    type="bool", value=true,
  },
  allyOnly = {
    name="Only My Allies",
    desc="Only alert for my own or allied commanders (safer in UI due to LOS limits).",
    type="bool", value=true,
  },
  showText = {
    name="Show System Text",
    desc="Also print a system-style message in the lower-left feed.",
    type="bool", value=true,
  },
  volume = {
    name="Volume",
    desc="Overall volume for these two lines.",
    type="number", min=0, max=1, step=0.05, value=0.90,
  },
  soundDeath = {
    name="Sound: Commander Destroyed",
    desc="Path to .ogg when a commander actually dies.",
    type="text", value="LuaUI/Sounds/commander_chassis_destroyed.ogg",
  },
  soundUpgrade = {
    name="Sound: Upgrade Complete",
    desc="Path to .ogg when a commander morph finishes.",
    type="text", value="LuaUI/Sounds/upgrade_complete.ogg",
  },
  detectWindow = {
    name="Detection Window (frames)",
    desc="Time window to pair destroy→create (≈30 fps). Raise if your map/mod is laggy.",
    type="number", min=4, max=32, step=1, value=12,
  },
  detectRadius = {
    name="Detection Radius (elmos)",
    desc="XY distance for 'same spot' pairing. Raise if upgrades nudge position.",
    type="number", min=16, max=256, step=8, value=64,
  },
}

--------------------------------------------------------------------------------
-- Locals / helpers
--------------------------------------------------------------------------------
local spGetUnitTeam     = Spring.GetUnitTeam
local spGetTeamInfo     = Spring.GetTeamInfo
local spGetMyTeamID     = Spring.GetMyTeamID
local spGetUnitPosition = Spring.GetUnitPosition
local spPlaySoundFile   = Spring.PlaySoundFile
local spEcho            = Spring.Echo
local VFSFileExists     = VFS.FileExists

local myTeamID
local function MyAllyTeam()
  return select(6, spGetTeamInfo(myTeamID or spGetMyTeamID(), false))
end

local function IsAlliedToMe(teamID)
  if not options.allyOnly.value then return true end
  if not teamID then return false end
  local myAlly = MyAllyTeam()
  local ally   = select(6, spGetTeamInfo(teamID, false))
  return myAlly and ally and (myAlly == ally)
end

local function SystemText(msg)
  if options.showText.value then
    spEcho("game_message: " .. msg)
  end
end

local function SafePlay(path, vol)
  if not path or path == "" then return end
  if not VFSFileExists(path) then
    -- spEcho("game_message: Missing sound: "..path)
    return
  end
  spPlaySoundFile(path, math.max(0, math.min(1, vol or 1)))
end

local function Dist2DSq(x1,z1, x2,z2)
  local dx, dz = (x1 - x2), (z1 - z2)
  return dx*dx + dz*dz
end

-- Commander fingerprint tolerant to ZK variants (stock/custom/campaign/captured)
local function IsCommanderDef(unitDefID)
  local ud = UnitDefs[unitDefID]; if not ud then return false end
  local cp = ud.customParams or {}
  if cp.iscommander or cp.commander or cp.commtype or cp.modularcomm or cp.dynamic_comm or cp.dyncomm then
    return true
  end
  local n = (ud.name or ""):lower()
  if n:find("commander", 1, true) or n:find("dyn", 1, true) then
    return true
  end
  return false
end

--------------------------------------------------------------------------------
-- Detection state (UI-side pairing)
--------------------------------------------------------------------------------
-- pendingDeaths[oldID] = {team=, x=, z=, expire=frame+window}
local pendingDeaths = {}
-- recentCreates[i] = {unitID=, team=, x=, z=, expire=frame+prewin}
local recentCreates = {}
-- (Tiny pre-window for the rare case Create arrives first)
local RECENT_CREATE_WIN = 6  -- fixed small cache; main window is optioned

--------------------------------------------------------------------------------
-- UI Callins
--------------------------------------------------------------------------------
function widget:Initialize()
  myTeamID = spGetMyTeamID()
end

-- Pairing helper: try match a freshly created comm to a pending death (normal order)
local function TryPairCreate(team, x, z, nowFrame, radiusSq)
  local bestOld, bestDist = nil, 1e30
  for oldID, pd in pairs(pendingDeaths) do
    if pd.team == team and nowFrame <= pd.expire then
      local d2 = Dist2DSq(pd.x, pd.z, x, z)
      if d2 <= radiusSq and d2 < bestDist then
        bestDist, bestOld = d2, oldID
      end
    end
  end
  return bestOld
end

-- Rare order: Destroy after Create (use tiny cache)
local function TryPairWithRecentCreate(team, x, z, nowFrame, radiusSq)
  local bestIdx, bestDist = nil, 1e30
  for i=1,#recentCreates do
    local rc = recentCreates[i]
    if rc and rc.team == team and nowFrame <= rc.expire then
      local d2 = Dist2DSq(x, z, rc.x, rc.z)
      if d2 <= radiusSq and d2 < bestDist then
        bestDist, bestIdx = d2, i
      end
    end
  end
  return bestIdx
end

-- We keep everything ally-filtered early so we don't act on enemy events outside LOS
function widget:UnitCreated(unitID, unitDefID, unitTeam)
  if not IsCommanderDef(unitDefID) then return end
  if not IsAlliedToMe(unitTeam)    then return end

  local x, y, z = spGetUnitPosition(unitID)
  if not x then
    -- No position (out of LOS). UI can’t safely pair; cache briefly and hope Destroy comes with coords.
    x, z = 0, 0
  end
  local now      = Spring.GetGameFrame()
  local radius   = options.detectRadius.value or 64
  local radiusSq = radius * radius

  -- Normal order: Destroy then Create
  local bestOld = TryPairCreate(unitTeam, x, z, now, radiusSq)
  if bestOld then
    -- UPGRADE
    pendingDeaths[bestOld] = nil
    local vol = options.volume.value or 0.9
    SafePlay(options.soundUpgrade.value, vol)
    SystemText("Upgrade Complete.")
    return
  end

  -- Otherwise cache this create for the rare reversed order
  recentCreates[#recentCreates+1] = {
    unitID = unitID, team = unitTeam, x = x or 0, z = z or 0,
    expire = now + RECENT_CREATE_WIN,
  }
end

function widget:UnitDestroyed(unitID, unitDefID, unitTeam)
  if not IsCommanderDef(unitDefID) then return end
  if not IsAlliedToMe(unitTeam)    then return end

  local x, y, z = spGetUnitPosition(unitID)
  if not x then x, z = 0, 0 end  -- defensive; allied units usually have coords
  local now      = Spring.GetGameFrame()
  local radius   = options.detectRadius.value or 64
  local radiusSq = radius * radius

  -- Rare order: Create happened first → pair to mark as upgrade
  local idx = TryPairWithRecentCreate(unitTeam, x, z, now, radiusSq)
  if idx then
    -- UPGRADE
    local vol = options.volume.value or 0.9
    SafePlay(options.soundUpgrade.value, vol)
    SystemText("Upgrade Complete.")
    recentCreates[idx] = nil
    return
  end

  -- Normal path: queue as maybe-death; if no matching Create arrives soon, confirm death
  local window = options.detectWindow.value or 12
  pendingDeaths[unitID] = { team = unitTeam, x = x or 0, z = z or 0, expire = now + window }
end

function widget:GameFrame(n)
  -- Confirm genuine deaths (no upgrade match happened in time)
  for oldID, pd in pairs(pendingDeaths) do
    if n > pd.expire then
      local vol = options.volume.value or 0.9
      SafePlay(options.soundDeath.value, vol)
      SystemText("Commander Chassis Destroyed.")
      pendingDeaths[oldID] = nil
    end
  end
  -- Clean recent-create cache
  for i = #recentCreates, 1, -1 do
    local rc = recentCreates[i]
    if not rc or n > rc.expire then
      recentCreates[i] = nil
    end
  end
end
