function widget:GetInfo()
    return {
        name = "Unit Selector By Letter",
        desc = "Selects nearest unit(s) in a letter group using Mouse Back + Key combos with Ctrl move command and colored lines",
        author = "ChatGPT + FrequentPilgrim",
        date = "2025-06-12",
        license = "GNU GPL v2",
        layer = 0,
        enabled = true,
    }
end

local MOUSE_BACK_BUTTON = 4
local mouseBackHeld = false
local selectedUnitsThisCycle = {}
local lastSelectedUnitPositions = {}
local drawTimer = 0
local shiftHeld = false
local ctrlHeld = false
local hasClearedSelectionThisCycle = false

-- Keycode mapping
local keycodeToLetter = {}
for i = 65, 90 do
    local ch = string.char(i)
    keycodeToLetter[Spring.GetKeyCode(ch:lower())] = ch
end

function widget:MousePress(x, y, button)
    if button == MOUSE_BACK_BUTTON then
        mouseBackHeld = true
        selectedUnitsThisCycle = {}
        hasClearedSelectionThisCycle = false
        return true
    end
end

function widget:MouseRelease(x, y, button)
    if button == MOUSE_BACK_BUTTON then
        mouseBackHeld = false
        selectedUnitsThisCycle = {}
        hasClearedSelectionThisCycle = false
        return true
    end
end

function widget:KeyPress(key, mods, isRepeat)
    if not mouseBackHeld then return false end

    local letter = keycodeToLetter[key]
    if not letter then return false end

    local groupTable = WG.LetterUnitTypeMultiAutoGroups
    if not groupTable then
        Spring.Echo("[Selector] WG.LetterUnitTypeMultiAutoGroups is missing.")
        return false
    end

    local defNames = groupTable[letter]
    if not defNames then
        Spring.Echo("[Selector] No units assigned to letter group:", letter)
        return true
    end

    shiftHeld = mods.shift
    ctrlHeld = mods.ctrl

    local mx, my = Spring.GetMouseState()
    local type, pos = Spring.TraceScreenRay(mx, my, true)
    if type ~= "ground" or not pos then
        Spring.Echo("[Selector] Mouse not over ground.")
        return true
    end

    local myTeam = Spring.GetMyTeamID()
    local cx, cy, cz = pos[1], pos[2], pos[3]

    if ctrlHeld then
        -- Ctrl: select nearest idle unit, move it, accumulate selection like normal (clear selection only on first press)
        local candidates = {}

        for _, unitID in ipairs(Spring.GetAllUnits()) do
            if Spring.GetUnitTeam(unitID) == myTeam then
                local defID = Spring.GetUnitDefID(unitID)
                if defID then
                    local defName = UnitDefs[defID].name
                    if defNames[defName] then
                        if not selectedUnitsThisCycle[unitID] and (not shiftHeld or not Spring.IsUnitSelected(unitID)) then
                            local cmds = Spring.GetCommandQueue(unitID, 1)
                            local isIdle = (#cmds == 0)
                            if isIdle then
                                local ux, uy, uz = Spring.GetUnitPosition(unitID)
                                local distSq = (ux - cx)^2 + (uz - cz)^2
                                table.insert(candidates, { id = unitID, dist = distSq, pos = { ux, uy, uz } })
                            end
                        end
                    end
                end
            end
        end

        table.sort(candidates, function(a, b) return a.dist < b.dist end)

        local unitsToSelect = {}
        local newlySelectedPositions = {}

        if #candidates > 0 then
            local unitID = candidates[1].id
            table.insert(unitsToSelect, unitID)
            table.insert(newlySelectedPositions, candidates[1].pos)
            selectedUnitsThisCycle[unitID] = true

            Spring.GiveOrderToUnit(unitID, CMD.MOVE, { cx, cy, cz }, {})
        end

        if #unitsToSelect > 0 then
            if shiftHeld then
                Spring.SelectUnitArray(unitsToSelect, true)
            else
                if not hasClearedSelectionThisCycle then
                    Spring.SelectUnitArray(unitsToSelect, false)
                    hasClearedSelectionThisCycle = true
                else
                    Spring.SelectUnitArray(unitsToSelect, true)
                end
            end
            lastSelectedUnitPositions = newlySelectedPositions
            drawTimer = 20
        else
            lastSelectedUnitPositions = {}
            drawTimer = 0
        end

        return true
    else
        -- No Ctrl: original accumulate selection behavior, select nearest 1 unit
        local allUnits = Spring.GetAllUnits()
        local candidates = {}

        for _, unitID in ipairs(allUnits) do
            if Spring.GetUnitTeam(unitID) == myTeam then
                local udid = Spring.GetUnitDefID(unitID)
                if udid then
                    local defName = UnitDefs[udid].name
                    if defNames[defName] then
                        if not selectedUnitsThisCycle[unitID] and (not shiftHeld or not Spring.IsUnitSelected(unitID)) then
                            local ux, uy, uz = Spring.GetUnitPosition(unitID)
                            local distSq = (ux - cx)^2 + (uz - cz)^2
                            table.insert(candidates, { id = unitID, dist = distSq, pos = { ux, uy, uz } })
                        end
                    end
                end
            end
        end

        table.sort(candidates, function(a, b) return a.dist < b.dist end)

        local unitsToSelect = {}
        local newlySelectedPositions = {}

        local numToSelect = 1

        for i = 1, math.min(numToSelect, #candidates) do
            local candidate = candidates[i]
            table.insert(unitsToSelect, candidate.id)
            table.insert(newlySelectedPositions, candidate.pos)
            selectedUnitsThisCycle[candidate.id] = true
        end

        if #unitsToSelect > 0 then
            if shiftHeld then
                Spring.SelectUnitArray(unitsToSelect, true)
            else
                if not hasClearedSelectionThisCycle then
                    Spring.SelectUnitArray(unitsToSelect, false)
                    hasClearedSelectionThisCycle = true
                else
                    Spring.SelectUnitArray(unitsToSelect, true)
                end
            end

            lastSelectedUnitPositions = newlySelectedPositions
            drawTimer = 20
        else
            lastSelectedUnitPositions = {}
            drawTimer = 0
        end

        return true
    end
end

function widget:DrawWorld()
    if drawTimer > 0 and #lastSelectedUnitPositions > 0 then
        local mx, my = Spring.GetMouseState()
        local type, pos = Spring.TraceScreenRay(mx, my, true)
        if type == "ground" and pos then
            local cx, cy, cz = pos[1], pos[2], pos[3]

            local r, g, b = 0.6, 0.8, 1 -- Light blue (like lasso)
            if shiftHeld then
                r, g, b = 0, 1, 0 -- Green if shift is held
            elseif ctrlHeld then
                r, g, b = 1, 0, 0 -- Red if ctrl is held
            end

            gl.Color(r, g, b, drawTimer / 20)
            gl.LineWidth(3)
            gl.BeginEnd(GL.LINES, function()
                for _, unitPos in ipairs(lastSelectedUnitPositions) do
                    gl.Vertex(cx, cy + 10, cz)
                    gl.Vertex(unitPos[1], unitPos[2] + 10, unitPos[3])
                end
            end)
            gl.LineWidth(1)
            gl.Color(1, 1, 1, 1)
        end
        drawTimer = drawTimer - 1
    end
end
