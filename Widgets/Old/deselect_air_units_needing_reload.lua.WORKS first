function widget:GetInfo()
  return {
    name      = "Air Reload Filter (Pad-Needed Icon Truth)",
    desc      = "Removes aircraft that show the pad-needed/no-payload icon from your selection.",
    author    = "you + gpt",
    date      = "2025-08-29",
    license   = "MIT",
    version   = "2.0.0",
    layer     = 0,
    enabled   = true,
  }
end

----------------------------------------------------------------
-- Epic Menu (stable, minimal)
----------------------------------------------------------------

options_path = "Settings/Misc/Air Reload Filter"

options = {
  runNow = {
    name = "Deselect Pad-Needed Aircraft (Run Now)",
    type = "button",
    desc = "Click to remove aircraft that show the pad-needed/no-payload icon from your CURRENT selection.",
    OnChange = function() DeselectPadNeeded(false, true) end,
  },

  autoFilter = {
    name = "Auto-filter On Selection Change",
    type = "bool",
    value = false,
    desc = "Whenever your selection changes, automatically prune pad-needed aircraft.",
    noHotkey = true,
  },

  neverEmpty = {
    name = "Never Empty Selection",
    type = "bool",
    value = true,
    desc = "If every selected air unit needs a pad, keep the selection unchanged (failsafe).",
    noHotkey = true,
  },

  -- Off by default; only for edge cases. The icon/RulesParam path is the ground truth.
  useWeaponHeuristic = {
    name = "Fallback: Weapon Reload Heuristic",
    type = "bool",
    value = false,
    desc = "If no pad-needed flags exist, consider deep reload frames. Not needed for the portrait icon behavior.",
    noHotkey = true,
  },

  verbose = {
    name = "Console Messages",
    type = "bool",
    value = true,
    desc = "Show a short console message when filtering removes units.",
    noHotkey = true,
  },

  infoHotkey = {
    name  = "How to Add a Hotkey",
    type  = "text",
    value = "Open Menu ▶ Hotkeys, search for deselect_air_reload, and bind any key you want.",
  },
}

----------------------------------------------------------------
-- Locals
----------------------------------------------------------------

local spGetSelectedUnits   = Spring.GetSelectedUnits
local spGetUnitDefID       = Spring.GetUnitDefID
local spGetUnitRulesParam  = Spring.GetUnitRulesParam
local spGetUnitWeaponState = Spring.GetUnitWeaponState
local spGetGameFrame       = Spring.GetGameFrame
local spSelectUnitArray    = Spring.SelectUnitArray
local Echo                 = Spring.Echo

-- Air check: engine UnitDef flag
local function IsAir(udid)
  local ud = udid and UnitDefs[udid]
  return ud and ud.canFly
end

-- These are the *actual* flags Zero-K gadgets/hud use for the “needs pad/no payload” state.
-- (Different planes/gadgets may use different keys; we check several, truthy if ≠ 0.)
local PAD_RULE_KEYS = {
  "rearm", "wantPad", "padWait", "padWanted", "needsRefuel", "needsReload", "noammo",
}

-- EXACT behavior the icon represents: a pad-needed / no-payload flag is set.
local function PlaneNeedsPad(unitID)
  for i = 1, #PAD_RULE_KEYS do
    local v = spGetUnitRulesParam(unitID, PAD_RULE_KEYS[i])
    if v and v ~= 0 then
      return true
    end
  end
  return false
end

-- Optional fallback (off by default): deep weapon reload heuristic.
local function PlaneLikelyReloading(unitID, udid)
  local ud = UnitDefs[udid]
  local weapons = ud and ud.weapons
  local wCount = weapons and #weapons or 0
  if wCount == 0 then return false end

  local gf = spGetGameFrame()
  for i = 1, wCount do
    -- Spring.GetUnitWeaponState returns multiple values:
    -- angleGood, loaded, reloadFrame, salvoLeft, numStockpiled
    local _, loaded, reloadFrame, _, numStockpiled = spGetUnitWeaponState(unitID, i)
    if loaded == false and (reloadFrame or 0) > (gf + 5) then
      return true
    end
    if numStockpiled and numStockpiled <= 0 then
      return true
    end
  end
  return false
end

local function isVerbose()   return options and options.verbose and options.verbose.value end
local function neverEmpty()  return options and options.neverEmpty and options.neverEmpty.value end
local function useHeur()     return options and options.useWeaponHeuristic and options.useWeaponHeuristic.value end

-- Core op
function DeselectPadNeeded(quiet, forceVerbose)
  local sel = spGetSelectedUnits()
  if not sel or #sel == 0 then return end

  local keep, removed = {}, 0
  local totalAir, totalPad = 0, 0

  for i = 1, #sel do
    local u = sel[i]
    local udid = spGetUnitDefID(u)
    if udid and IsAir(udid) then
      totalAir = totalAir + 1
      local padNeeded = PlaneNeedsPad(u)
      if (not padNeeded) and useHeur() then
        padNeeded = PlaneLikelyReloading(u, udid)
      end
      if padNeeded then
        removed = removed + 1
        totalPad = totalPad + 1
      else
        keep[#keep + 1] = u
      end
    else
      keep[#keep + 1] = u -- non-air always kept
    end
  end

  -- Failsafe: don't empty selection if user prefers that.
  if removed > 0 then
    if neverEmpty() and (#keep == 0) then
      if (not quiet and isVerbose()) or forceVerbose then
        Echo("game_message: All selected air need a pad; leaving selection unchanged.")
      end
      return
    end
    spSelectUnitArray(keep, false)
    if (not quiet and isVerbose()) or forceVerbose then
      Echo(("game_message: Removed %d pad-needed aircraft (icon state) from selection."):format(removed))
    end
  else
    if (not quiet and isVerbose()) or forceVerbose then
      if totalAir > 0 then
        Echo("game_message: All selected aircraft are stocked (no pad-needed icon).")
      else
        Echo("game_message: No aircraft in selection.")
      end
    end
  end
end

----------------------------------------------------------------
-- Lifecycle & Hotkey Action (bind from Hotkeys UI)
----------------------------------------------------------------

function widget:Initialize()
  -- Register action that appears in Hotkeys UI (search: deselect_air_reload)
  widgetHandler:AddAction("deselect_air_reload", function()
    DeselectPadNeeded(false, false)
  end, nil, "t")

  if isVerbose() then
    Echo("game_message: Bind in Menu ▶ Hotkeys (search 'deselect_air_reload').")
  end
end

function widget:Shutdown()
  widgetHandler:RemoveAction("deselect_air_reload")
end

function widget:SelectionChanged()
  if options and options.autoFilter and options.autoFilter.value then
    DeselectPadNeeded(true, false) -- quiet to avoid spam
  end
end
