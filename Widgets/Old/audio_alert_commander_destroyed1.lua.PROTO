function widget:GetInfo()
  return {
    name      = "Audio Alert - Commander Destroyed Sound",
    desc      = "Plays a sound when your commander is destroyed (supports all commander types)",
    author    = "FrequentPilgrim (+Epic Menu toggle patch)",
    date      = "2025-08-16",
    license   = "GNU GPL v2",
    layer     = 0,
    enabled   = true,
  }
end

--------------------------------------------------------------------------------
-- Epic Menu Toggle (additive, with persistence)
--------------------------------------------------------------------------------
options = options or {}
options.enableCommanderDestroyedAlert = {
  name  = "Commander Destroyed Alert",
  desc  = "Play an alert sound when your commander has been destroyed.",
  type  = "bool",
  value = true,
  path  = "Settings/Audio/Audio Alerts",
}

function widget:GetConfigData()
  return {
    enableCommanderDestroyedAlert = options.enableCommanderDestroyedAlert
      and options.enableCommanderDestroyedAlert.value or true,
  }
end

function widget:SetConfigData(data)
  if data and data.enableCommanderDestroyedAlert ~= nil
     and options and options.enableCommanderDestroyedAlert then
    options.enableCommanderDestroyedAlert.value = data.enableCommanderDestroyedAlert
  end
end

local function FeatureEnabled()
  return options and options.enableCommanderDestroyedAlert
     and options.enableCommanderDestroyedAlert.value
end

--------------------------------------------------------------------------------
-- Original configuration & locals
--------------------------------------------------------------------------------
-- Spring functions
local GetMyTeamID       = Spring.GetMyTeamID
local GetUnitRulesParam = Spring.GetUnitRulesParam
local PlaySoundFile     = Spring.PlaySoundFile
local VFS_FileExists    = VFS.FileExists

local UnitDefs          = UnitDefs
local SOUND_FILE        = "LuaUI/sounds/commanderchassisdestroyed.ogg"

-- Known commander unitDef name patterns
local commanderPrefixes = {
  "dynrecon", "dynstrike", "dynassault", "dynsupport", "dynknight",
  "dyntrainer", "zk_commander", "zk_custom", "zk_chassis", "comm"
}

-- Commander detection logic (unchanged)
local function IsCommander(unitID, unitDefID)
  local unitDef = UnitDefs[unitDefID]
  if not unitDef then return false end

  local name     = unitDef.name or ""
  local isCmd    = GetUnitRulesParam(unitID, "iscommander")
  local commtype = GetUnitRulesParam(unitID, "commtype")
  local level    = GetUnitRulesParam(unitID, "level")

  if isCmd == 1 then return true end
  if commtype or (level and level > 0) then return true end

  for _, prefix in ipairs(commanderPrefixes) do
    if name:sub(1, #prefix) == prefix then return true end
  end

  if name:find("_base") then return true end
  return false
end

--------------------------------------------------------------------------------
-- Engine Hooks
--------------------------------------------------------------------------------
function widget:UnitDestroyed(unitID, unitDefID, unitTeam)
  if not FeatureEnabled() then return end
  if unitTeam ~= GetMyTeamID() then return end
  if not IsCommander(unitID, unitDefID) then return end

  PlaySoundFile(SOUND_FILE, 3.0)
end

function widget:Initialize()
  if not VFS_FileExists(SOUND_FILE) then
    widgetHandler:RemoveWidget(self)
  end
end
