--------------------------------------------------------------------------------
-- Letter UnitType Multi Auto Groups
-- Player-visible messages ONLY for Assign & Clear
--------------------------------------------------------------------------------

local versionNum = '2025-08-13.b'

function widget:GetInfo()
    return {
        name    = "Letter UnitType Multi Auto Groups",
        desc    = "Assign unit types to letter groups A–Z; Meta+letter selects, Shift adds, Ctrl filters. Backspace+Meta+letter clears that letter. v"..versionNum,
        author  = "FrequentPilgrim (with JH)",
        date    = "2025-08-13",
        license = "GNU GPL v2 or later",
        layer   = 0,
        enabled = true,
    }
end

--------------------------------------------------------------------------------
-- Options (Epic Menu)
--------------------------------------------------------------------------------

-- Forward declarations so Epic Menu button closures can call them:
local AssignLetterGroup
local ClearLetterGroup

options = {
    {
        key    = 'enableAutoGroups',
        name   = 'Enable Letter UnitType Auto Groups',
        desc   = 'Toggle letter-based assignment and selection.',
        type   = 'bool',
        value  = true,
        scope  = 'widget',
    },
}

do
    local function _append(item) options[#options+1] = item end

    -- Label: Assign
    _append({ key = "lbl_assign_letters", type = "text", name = "Quick Assign (Selected → Letter)", value = "" })

    for byte = string.byte("A"), string.byte("Z") do
        local letter = string.char(byte)
        _append({
            key      = "assign_" .. letter,
            name     = "Assign → " .. letter,
            desc     = "Assign CURRENT selection’s unit types to group " .. letter,
            type     = "button",
            noHotkey = true,
            scope    = "widget",
            OnChange = function() AssignLetterGroup(letter) end,
        })
    end

    -- Label: Clear
    _append({ key = "lbl_clear_letters", type = "text", name = "Quick Clear (Erase Letter Group)", value = "" })

    for byte = string.byte("A"), string.byte("Z") do
        local letter = string.char(byte)
        _append({
            key      = "clear_" .. letter,
            name     = "Clear " .. letter,
            desc     = "Remove ALL unit types from group " .. letter,
            type     = "button",
            noHotkey = true,
            scope    = "widget",
            OnChange = function() ClearLetterGroup(letter) end,
        })
    end
end

--------------------------------------------------------------------------------
-- State
--------------------------------------------------------------------------------

local assignedGroups = {}  -- letter -> set of unitDefNames { [unitDefName] = true, ... }

local keycodeToLetter = {}
for i = 65, 90 do -- 'A'..'Z'
    local ch = string.char(i)
    keycodeToLetter[Spring.GetKeyCode(ch:lower())] = ch
end

local backspaceKey = Spring.GetKeyCode("backspace")
local backspaceDown = false

--------------------------------------------------------------------------------
-- Messaging (system-style chat/console)
-- NOTE: ONLY used by Assign & Clear, nowhere else.
--------------------------------------------------------------------------------

local function ShowMessage(msg)
    Spring.Echo('game_message: ' .. msg)
end

--------------------------------------------------------------------------------
-- Helpers
--------------------------------------------------------------------------------

local function GetUnitsInGroup(letter)
    local defNameSet = assignedGroups[letter]
    if not defNameSet then return {} end

    local myTeam = Spring.GetMyTeamID()
    local units = Spring.GetTeamUnits(myTeam)
    local toSelect = {}

    for _, unitID in ipairs(units) do
        local udid = Spring.GetUnitDefID(unitID)
        if udid then
            local defName = UnitDefs[udid].name
            if defNameSet[defName] then
                toSelect[#toSelect+1] = unitID
            end
        end
    end
    return toSelect
end

--------------------------------------------------------------------------------
-- Actions
-- ONLY Assign & Clear emit ShowMessage(); Select/Add/Filter are silent.
--------------------------------------------------------------------------------

AssignLetterGroup = function(letter)
    local selUnits = Spring.GetSelectedUnits()
    if #selUnits == 0 then
        ShowMessage("No units selected to assign group " .. letter)
        return
    end

    assignedGroups[letter] = assignedGroups[letter] or {}
    local addedCount = 0
    local touched = 0

    for _, unitID in ipairs(selUnits) do
        local udid = Spring.GetUnitDefID(unitID)
        if udid then
            local defName = UnitDefs[udid].name
            if defName then
                touched = touched + 1
                if not assignedGroups[letter][defName] then
                    assignedGroups[letter][defName] = true
                    addedCount = addedCount + 1
                end
            end
        end
    end

    if addedCount > 0 then
        ShowMessage("Added " .. addedCount .. " unit type(s) to group " .. letter)
    else
        ShowMessage("No new unit types added to group " .. letter .. " (touched " .. touched .. ")")
    end
end

ClearLetterGroup = function(letter)
    if assignedGroups[letter] then
        assignedGroups[letter] = nil
        ShowMessage("Cleared group " .. letter)
    else
        ShowMessage("Group " .. letter .. " is not assigned")
    end
end

local function SelectLetterGroup(letter)
    -- Silent selection
    Spring.SelectUnitArray(GetUnitsInGroup(letter), false)
end

local function AddToSelection(letter)
    -- Silent additive selection
    Spring.SelectUnitArray(GetUnitsInGroup(letter), true)
end

local function FilterSelection(letter)
    -- Silent filtering
    local current = Spring.GetSelectedUnits()
    if #current == 0 then return end

    local defNameSet = assignedGroups[letter]
    if not defNameSet then return end

    local filtered = {}
    for _, unitID in ipairs(current) do
        local udid = Spring.GetUnitDefID(unitID)
        if udid then
            local defName = UnitDefs[udid].name
            if defNameSet[defName] then
                filtered[#filtered+1] = unitID
            end
        end
    end
    Spring.SelectUnitArray(filtered, false)
end

--------------------------------------------------------------------------------
-- Input
--------------------------------------------------------------------------------

function widget:KeyPress(key, mods, isRepeat)
    if not options[1].value then return false end  -- Respect Epic Menu toggle

    if key == backspaceKey then
        backspaceDown = true
        return false
    end

    local letter = keycodeToLetter[key]
    if not letter or not mods.meta then return false end

    if backspaceDown then
        -- Backspace + Meta + Letter => Clear (with message)
        ClearLetterGroup(letter)
        return true
    elseif mods.alt then
        -- Alt + Meta + Letter => Assign (with message)
        AssignLetterGroup(letter)
        return true
    elseif mods.shift then
        -- Shift + Meta + Letter => Add (silent)
        AddToSelection(letter)
        return true
    elseif mods.ctrl then
        -- Ctrl + Meta + Letter => Filter (silent)
        FilterSelection(letter)
        return true
    else
        -- Meta + Letter => Select (silent)
        SelectLetterGroup(letter)
        return true
    end
end

function widget:KeyRelease(key)
    if key == backspaceKey then
        backspaceDown = false
    end
end

--------------------------------------------------------------------------------
-- Save/Load
--------------------------------------------------------------------------------

function widget:GetConfigData()
    local saved = { enableAutoGroups = options[1].value }
    for letter, defSet in pairs(assignedGroups) do
        saved[letter] = {}
        for defName in pairs(defSet) do
            saved[letter][#saved[letter]+1] = defName
        end
    end
    return saved
end

function widget:SetConfigData(data)
    if type(data) == "table" then
        options[1].value = (data.enableAutoGroups ~= false)
        assignedGroups = {}
        for letter, defList in pairs(data) do
            if type(defList) == "table" then
                local set = {}
                for _, defName in ipairs(defList) do
                    set[defName] = true
                end
                assignedGroups[letter] = set
            end
        end

        -- Keep this as a normal (debug-style) echo, NOT a system-style message:
        Spring.Echo("[LetterUnitTypeGroups] Loaded saved groups")
    end
end
