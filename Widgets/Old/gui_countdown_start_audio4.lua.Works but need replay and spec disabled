function widget:GetInfo()
  return {
    name      = "Countdown Start Audio",
    desc      = "Plays once at the STARTING splash: on 3 (normal) or first tick after ready=true (ForceStart).",
    author    = "You",
    date      = "2025-08-17",
    license   = "GPLv2+",
    layer     = -100,
    enabled   = true
  }
end

-- ====== CONFIG ======
local START_SOUND = 'LuaUI/Sounds/battle_begins_in_3_2_1.ogg'
local START_VOL   = 1.0
local START_CHAN  = 'ui'
local DEBUG       = true  -- set true to print short traces

-- ====== STATE ======
local played          = false
local armedReady      = false   -- set by GameSetup(ready=true)
local consumedArmedTick = false -- ensures we only use the first tick after arming
local lastS           = nil

local function dbg(msg) if DEBUG then Spring.Echo('game_message:[Countdown] '..msg) end end

local function playOnce(tag)
  if played then return end
  if VFS.FileExists(START_SOUND) then
    Spring.PlaySoundFile(START_SOUND, START_VOL, START_CHAN)
    played = true
    dbg('fired '..(tag or ''))
  else
    dbg('missing sound: '..START_SOUND)
  end
end

-- Arm on local ready (works in online bot lobbies and MP); we won't play yet.
function widget:GameSetup(state, ready, playerStates)
  if played then return end
  if ready and not armedReady then
    armedReady = true
    consumedArmedTick = false
    dbg('armed (local ready)')
  end
end

-- Unified trigger:
--  A) ForceStart/quick start: if armed, fire on the **very first** pregame tick after arming (any value).
--  B) Normal countdown: fire exactly on the transition into 3 (…>3 -> 3).
function widget:PreGameTimekeeping(secondsUntilStart)
  if played then return end
  local s = math.floor((secondsUntilStart or 9999) + 0.0001)

  -- A) First tick after arming -> fire now (lines up with STARTING splash even if no ≤3 tick occurs)
  if armedReady and not consumedArmedTick then
    consumedArmedTick = true
    dbg('first tick after ready: '..tostring(s))
    playOnce('(armed→first-tick)')
    lastS = s
    return
  end

  -- B) Exact-on-3 for natural countdowns
  if s == 3 and (lastS == nil or lastS > 3) then
    playOnce('(hit-3)')
    lastS = s
    return
  end

  lastS = s
end

-- Clean up when match actually begins
function widget:GameStart()
  widgetHandler:RemoveCallIn("PreGameTimekeeping")
end

-- Reset on reloads
function widget:Shutdown()
  played = false
  armedReady = false
  consumedArmedTick = false
  lastS = nil
end
