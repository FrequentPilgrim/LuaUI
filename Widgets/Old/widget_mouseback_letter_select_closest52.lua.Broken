function widget:GetInfo()
    return {
        name = "Unit Selector By Letter",
        desc = "Selects nearest unit(s) in a letter group using Mouse Back + Key combos",
        author = "ChatGPT + FrequentPilgrim",
        date = "2025-06-13",
        license = "GNU GPL v2",
        layer = 0,
        enabled = true,
    }
end

local MOUSE_BACK_BUTTON = 4
local mouseBackHeld = false
local selectedUnitsThisCycle = {}
local lastSelectedUnitPositions = {}
local drawTimer = 0
local shiftHeld, ctrlHeld, altHeld = false, false, false
local hasClearedSelectionThisCycle = false

local CMD_MOVE = CMD.MOVE
local CMD_FIGHT = CMD.FIGHT  -- Attack-Move command

local keycodeToLetter = {}
for i = 65, 90 do
    keycodeToLetter[Spring.GetKeyCode(string.char(i):lower())] = string.char(i)
end

function widget:MousePress(x, y, button)
    if button == MOUSE_BACK_BUTTON then
        mouseBackHeld = true
        selectedUnitsThisCycle = {}
        hasClearedSelectionThisCycle = false
    else
        if mouseBackHeld then
            mouseBackHeld = false
            selectedUnitsThisCycle = {}
            hasClearedSelectionThisCycle = false
        end
    end
    return false
end

function widget:MouseRelease(x, y, button)
    if button == MOUSE_BACK_BUTTON then
        mouseBackHeld = false
        selectedUnitsThisCycle = {}
        hasClearedSelectionThisCycle = false
    else
        if mouseBackHeld then
            mouseBackHeld = false
            selectedUnitsThisCycle = {}
            hasClearedSelectionThisCycle = false
        end
    end
    return false
end

function widget:Update()
    local _, _, mouseButtons = Spring.GetMouseState()
    -- Check if Mouse 4 (bit 16) is pressed
    -- Mouse buttons bits: Button 1 = bit 1 (1), Button 2 = bit 2 (2), Button 3 = bit 3 (4), Button 4 = bit 4 (8), etc.
    -- But according to Spring docs, mouseButtons is a bitmask where bit 1 is left button (1), bit 2 right button (2), bit 3 middle (4), bit 4 wheelup (8), etc.
    -- However, actual mapping can vary by platform. 
    -- Let's check bit 4 = 8 or bit 5 = 16 for Mouse 4. Usually Mouse 4 is bit 4 or 5 in the mask.
    -- We'll test both bits 8 and 16 and accept either as Mouse 4.

    local mouse4Pressed = false
    if mouseButtons then
        -- Check bits for mouse4
        if (mouseButtons & 8) ~= 0 or (mouseButtons & 16) ~= 0 then
            mouse4Pressed = true
        end
    end

    if mouse4Pressed and not mouseBackHeld then
        mouseBackHeld = true
        selectedUnitsThisCycle = {}
        hasClearedSelectionThisCycle = false
    elseif not mouse4Pressed and mouseBackHeld then
        mouseBackHeld = false
        selectedUnitsThisCycle = {}
        hasClearedSelectionThisCycle = false
    end
end

function widget:KeyPress(key, mods, isRepeat)
    if not mouseBackHeld then return false end

    local letter = keycodeToLetter[key]
    if not letter then return false end

    local groupTable = WG.LetterUnitTypeMultiAutoGroups
    if not groupTable then
        Spring.Echo("[Selector] WG.LetterUnitTypeMultiAutoGroups is missing.")
        return false
    end

    local defNames = groupTable[letter]
    if not defNames then
        Spring.Echo("[Selector] No units assigned to letter group:", letter)
        return true
    end

    shiftHeld, ctrlHeld, altHeld = mods.shift, mods.ctrl, mods.alt

    local mx, my = Spring.GetMouseState()
    local type, pos = Spring.TraceScreenRay(mx, my, true)
    if type ~= "ground" or not pos then
        Spring.Echo("[Selector] Mouse not over ground.")
        return true
    end

    local allUnits = Spring.GetAllUnits()
    local myTeam = Spring.GetMyTeamID()
    local cx, cy, cz = pos[1], pos[2], pos[3]
    local candidates = {}

    for _, unitID in ipairs(allUnits) do
        if Spring.GetUnitTeam(unitID) == myTeam then
            local udid = Spring.GetUnitDefID(unitID)
            if udid then
                local def = UnitDefs[udid]
                local defName = def.name
                if defNames[defName] and not selectedUnitsThisCycle[unitID]
                  and (not shiftHeld or not Spring.IsUnitSelected(unitID))
                  and not def.isBuilding then  -- exclude buildings always
                    local isIdle = (#Spring.GetUnitCommands(unitID, 1) == 0)
                    if (not ctrlHeld and not altHeld) or isIdle then
                        local ux, uy, uz = Spring.GetUnitPosition(unitID)
                        local distSq = (ux - cx)^2 + (uz - cz)^2
                        table.insert(candidates, { id = unitID, dist = distSq, pos = { ux, uy, uz } })
                    end
                end
            end
        end
    end

    table.sort(candidates, function(a, b) return a.dist < b.dist end)

    local unitsToSelect, newlySelectedPositions = {}, {}
    for i = 1, math.min(1, #candidates) do
        local candidate = candidates[i]
        table.insert(unitsToSelect, candidate.id)
        table.insert(newlySelectedPositions, candidate.pos)
        selectedUnitsThisCycle[candidate.id] = true

        if ctrlHeld then
            Spring.GiveOrderToUnit(candidate.id, CMD_MOVE, {cx, cy, cz}, {})
        elseif altHeld then
            Spring.GiveOrderToUnit(candidate.id, CMD_FIGHT, {cx, cy, cz}, {})
        end
    end

    if #unitsToSelect > 0 then
        if shiftHeld then
            Spring.SelectUnitArray(unitsToSelect, true)
        else
            if not hasClearedSelectionThisCycle then
                Spring.SelectUnitArray(unitsToSelect, false)
                hasClearedSelectionThisCycle = true
            else
                Spring.SelectUnitArray(unitsToSelect, true)
            end
        end

        lastSelectedUnitPositions = newlySelectedPositions
        drawTimer = 20
    else
        lastSelectedUnitPositions = {}
        drawTimer = 0
    end

    return true
end

function widget:DrawWorld()
    if drawTimer > 0 and #lastSelectedUnitPositions > 0 then
        local mx, my = Spring.GetMouseState()
        local type, pos = Spring.TraceScreenRay(mx, my, true)
        if type == "ground" and pos then
            local cx, cy, cz = pos[1], pos[2], pos[3]
            local r, g, b = 0.6, 0.8, 1
            if shiftHeld then
                r, g, b = 0, 1, 0
            elseif ctrlHeld then
                r, g, b = 1, 0, 0
            elseif altHeld then
                r, g, b = 1, 0, 1
            end

            gl.Color(r, g, b, drawTimer / 20)
            gl.LineWidth(3)
            gl.BeginEnd(GL.LINES, function()
                for _, unitPos in ipairs(lastSelectedUnitPositions) do
                    gl.Vertex(cx, cy + 10, cz)
                    gl.Vertex(unitPos[1], unitPos[2] + 10, unitPos[3])
                end
            end)
            gl.LineWidth(1)
            gl.Color(1
